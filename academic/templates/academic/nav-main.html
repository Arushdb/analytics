<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Nav Flow Mock — University Analytics (Filtered + Pagination)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI",
          Roboto, "Helvetica Neue", Arial;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-60 bg-blue-800 text-white p-4">
      <div class="text-2xl font-bold mb-6">Univ Analytics</div>
      <nav class="space-y-2">
        <a href="#dashboard" class="block px-3 py-2 rounded hover:bg-blue-700"
          >Dashboard</a
        >
        <a href="#students" class="block px-3 py-2 rounded hover:bg-blue-700"
          >Students</a
        >
        <a href="#teachers" class="block px-3 py-2 rounded hover:bg-blue-700"
          >Teachers</a
        >
        <a href="#reports" class="block px-3 py-2 rounded hover:bg-blue-700"
          >Reports</a
        >
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6">
      <!-- Top bar -->
      <header class="flex items-center justify-between mb-6">
        <h1 id="pageTitle" class="text-2xl font-semibold">Dashboard</h1>
        <div class="text-sm text-gray-600">Demo user</div>
      </header>

      <!-- Views container -->
      <div id="views">
        <div
          id="loader"
          class="fixed inset-0 bg-black bg-opacity-20 hidden z-50"
        >
          <div class="absolute inset-0 flex items-center justify-center">
            <div
              class="spinner"
              role="status"
              aria-live="polite"
              aria-label="Loading"
            ></div>
          </div>
        </div>
        <!-- Dashboard -->
        <section id="view-dashboard">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded shadow">
              Total Students<br /><strong>420</strong>
            </div>
            <div class="bg-white p-4 rounded shadow">
              Avg Attendance<br /><strong>82%</strong>
            </div>
            <div class="bg-white p-4 rounded shadow">
              Pass Rate<br /><strong>75%</strong>
            </div>
          </div>
          <div class="bg-white p-6 rounded shadow">
            Dashboard charts / KPIs (demo)
          </div>
        </section>

        <!-- Students list with filters + pagination -->
        <section id="view-students" class="hidden">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-xl font-semibold">Students</h2>
            <div class="flex items-center gap-2">
              <select
                id="sessionSelect"
                class="border rounded px-2 py-1 text-sm"
              ></select>

              <label for="program">Choose Program:</label>
              <input
                list="programList"
                id="programInput"
                name="program"
                placeholder="Type to search..."
              />
              <input type="hidden" id="programId" name="program_id" />
              <datalist id="programList"></datalist>
              <input
                id="rollnoFilter"
                type="text"
                class="border rounded px-2 py-1 text-sm"
                placeholder="Enter Roll Number"
                style="min-width: 140px; max-width: 260px"
              />
              <input
                id="branchFilter"
                type="text"
                class="border rounded px-2 py-1 text-sm"
                placeholder="Enter Branch"
                style="min-width: 140px; max-width: 260px"
              />
              <input
                id="subjectFilter"
                type="text"
                class="border rounded px-2 py-1 text-sm"
                placeholder="Enter Subject code"
                style="min-width: 140px; max-width: 260px"
              />
              <button
                id="applyFilters"
                class="bg-blue-600 text-white px-3 py-1 rounded text-sm"
              >
                Apply
              </button>
            </div>
          </div>

          <div class="bg-white rounded shadow overflow-hidden">
            <table class="min-w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">Roll</th>
                  <th class="p-3 text-left">Name</th>
                  <th class="p-3 text-left">Program</th>
                  <th class="p-3 text-left">semester</th>
                  <th class="p-3 text-left">branch</th>
                  <th class="p-3 text-left">spec</th>
                  <th class="p-3 text-left">subject</th>
                  <th class="p-3 text-left">Session</th>
                </tr>
              </thead>
              <tbody id="studentsTableBody"></tbody>
            </table>
          </div>

          <!-- Pagination controls -->
          <div class="mt-3 flex items-center justify-between">
            <div class="text-sm text-gray-600">
              Showing <span id="showingRange">0</span> of
              <span id="totalCount">0</span>
            </div>
            <div class="flex items-center gap-2">
              <label for="pageSize" class="text-sm text-gray-600"
                >Page size</label
              >
              <select id="pageSize" class="border rounded px-2 py-1 text-sm">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="25">25</option>
              </select>
              <button id="prevPage" class="px-2 py-1 border rounded">
                Prev
              </button>
              <span id="currentPage" class="px-2">1</span>
              <button id="nextPage" class="px-2 py-1 border rounded">
                Next
              </button>
            </div>
          </div>
        </section>

        <!-- Program Detail -->
        <section id="view-program" class="hidden">
          <div class="mb-4 flex items-center justify-between">
            <div>
              <h2 id="classLabel" class="text-xl font-semibold">Class: —</h2>
              <p id="classMeta" class="text-sm text-gray-600">
                Department • Program
              </p>
            </div>
            <div>
              <button
                id="backToStudentsBtn"
                class="text-sm text-blue-600 hover:underline"
              >
                Back to Students
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded shadow">
              Students: <strong id="clsCount">—</strong>
            </div>
            <div class="bg-white p-4 rounded shadow">
              Avg %: <strong id="clsAvg">—</strong>
            </div>
            <div class="bg-white p-4 rounded shadow">
              Pass %: <strong id="clsPass">—</strong>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded shadow">
              <h3 class="font-medium mb-2">Subjects</h3>
              <div id="classSubjects" class="space-y-2"></div>
            </div>

            <div class="bg-white p-4 rounded shadow lg:col-span-2">
              <h3 class="font-medium mb-2">Class Overview (charts)</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-3 bg-gray-50 rounded">
                  <strong>Avg by Course (placeholder)</strong>
                </div>
                <div class="p-3 bg-gray-50 rounded">
                  <strong>Pass Rate (placeholder)</strong>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white p-4 rounded shadow mb-4">
            <h3 class="font-medium mb-2">Students in Class</h3>
            <table class="min-w-full">
              <thead>
                <tr>
                  <th class="p-2 text-left">Roll</th>
                  <th class="p-2 text-left">Name</th>
                </tr>
              </thead>
              <tbody id="classStudentsBody"></tbody>
            </table>
          </div>
        </section>

        <!-- Subject Detail -->
        <section id="view-subject" class="hidden">
          <div class="mb-4 flex items-center justify-between">
            <div>
              <h2 id="subjectLabel" class="text-xl font-semibold">
                Subject Academic.subject — —
              </h2>
              <p id="subjectMeta" class="text-lg text-blue-600">
                Class • Program
              </p>
            </div>
            <div>
              <button
                id="backTostudentsFronSubject"
                class="text-sm text-blue-600 hover:underline"
              >
                Back to Students
              </button>
            </div>
          </div>
          <!-- Include the partial and pass parameters -->
          {% include "academic/components.html" with section_title="Student Evaluation" %}
        </section>
        <section id="view-rollno" class="hidden">
          <div class="mb-4 flex items-center justify-between">
            <div>
              <h2 id="rollnoLabel" class="text-xl font-semibold">
                Roll no:  — —
              </h2>
              <p id="rollnoMeta" class="text-lg text-blue-600">
                Class • Program
              </p>
            </div>
            <div>
              <button
                id="backTostudentsFromRollno"
                class="text-sm text-blue-600 hover:underline"
              >
                Back to Students
              </button>
            </div>
          </div>
          <!-- Include the partial and pass parameters -->
          {% include "academic/student_performance.html" with section_title="Roll Number Evaluation" %}
          
        </section>


        <!-- Student Detail -->
        <section id="view-student" class="hidden">
          <div class="mb-4 flex items-center justify-between">
            <div>
              <h2 id="stuName" class="text-xl font-semibold">Student — —</h2>
              <p id="stuMeta" class="text-sm text-gray-600">Roll • Program</p>
            </div>
            <div>
              <a
                id="backToClassLink"
                class="text-sm text-blue-600 hover:underline"
                href="#"
                >Back to class</a
              >
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded shadow">
              Latest % <strong id="stuPct">—</strong>
            </div>
            <div class="bg-white p-4 rounded shadow">
              Attendance <strong id="stuAtt">—</strong>
            </div>
          </div>

          <div class="bg-white p-4 rounded shadow mt-4">
            <h3 class="font-medium mb-2">Subject-wise Marks</h3>
            <table class="min-w-full">
              <thead>
                <tr>
                  <th class="p-2 text-left">Subject</th>
                  <th class="p-2 text-left">Avg %</th>
                </tr>
              </thead>
              <tbody id="studentSubjectsBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <script>
      window.csrfToken = "{{ csrf_token }}";
      //let defaultSession="" ;
      // create one global namespace (recommended)
      window.academic = window.academic || {};
      const Academic = window.academic;

      Academic.selected_pgmid = null;
      Academic.selected_pgm = null;
      Academic.selected_year = null;
      Academic.subject = null;

      // Inject it into the partial’s container dynamically

      function onSessionChange(e) {
        const sel = e.target;
        selectedValue = sel.value; // e.g. "" or "2024"
        Academic.selected_year = selectedValue ? selectedValue : "";
        const selectedText = sel.options[sel.selectedIndex].text;
        console.log(Academic.selected_year);
      }
      function onProgramChange(e) {
        const pgminput = document.getElementById("programInput");

        const datalist = document.getElementById("programList");

        const selected = [...datalist.options].find(
          (opt) => opt.value === pgminput.value
        );
        let id = selected ? selected.dataset.id : "";
        let pgm = selected ? selected.value : "";
        Academic.selected_pgmid = id;
        Academic.selected_pgm = pgm;
        console.log("selected program", pgm);
        console.log("selected id", id);
      }

      function getsessions() {
        const sessionSelect = document.getElementById("sessionSelect");
        const opt = document.createElement("option");
        opt.value = "All Sessions";
        opt.textContent = "All Sessions";
        sessionSelect.appendChild(opt);
        // AJAX call to h courses for the selected program and year
        fetch(`api/student/get-sessions/`)
          .then((response) => response.json())
          .then((data) => {
            data.years.forEach((year) => {
              const option = document.createElement("option");
              option.value = year;

              option.textContent = year;
              sessionSelect.appendChild(option);
            });

            // Now add the change listener (after options exist)
            sessionSelect.addEventListener("change", onSessionChange);

            //courseContainer.style.display = 'block';
          })
          .catch((error) => console.error("Error:", error));
      }

      function getprograms() {
        const datalist = document.getElementById("programList");
        
        fetch(`api/student/get-programs/`)
          .then((response) => response.json())
          .then((data) => {
            console.log("programs", data.programs);

            data.programs.forEach((pgm) => {
              const option = document.createElement("option");
              option.value = pgm.name;
              option.setAttribute("data-id", pgm.id);

              option.dataset.id = pgm.id;

              datalist.appendChild(option);
            });
            // Handle selection
            const pgminput = document.getElementById("programInput");
            const pgmid = document.getElementById("programId");
            pgminput.addEventListener("change", onProgramChange);

        
          })
          .catch((error) => console.error("Error:", error));
      }
      async function getstudents() {
        const params = new URLSearchParams();
        id = Academic.selected_pgmid;
        year = Academic.selected_year;
        let rollnoSelect = document.getElementById("rollnoFilter");
        let branchSelect = document.getElementById("branchFilter");
        let subjectSelect = document.getElementById("subjectFilter");

        let rollno = rollnoSelect.value.trim();
        let branch= branchSelect.value.trim();
        let subject = subjectSelect.value.trim();
        rollno = rollno ? rollno : "";
        branch = branch ? branch : "";
        subject = subject ? subject : "";
        if (id) params.set("program_id", id);
        if (year) params.set("year", year);
        params.set("rollno", rollno);
        params.set("branch", branch);
        params.set("subject", subject);
        params.set("limit", "100");
        params.set("offset", "0");
        const url = `/academic/login/api/student/get-students/?${params.toString()}`;
        const loader = document.getElementById("loader");
        loader.style.display = "block"; // show spinner
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (data.students) {

          console.log(data);
        }
        loader.style.display = "none"; // hide spinner
         const total = data.students.length;
         document.getElementById("totalCount").textContent = total;

          filteredList = data.students;
          currentPage = 1;
          pageSize = parseInt(document.getElementById("pageSize").value);
          renderPage();
         return data.students;
      }

      // Demo data: students (this list can be small; real app will query server with filters)
      
      // pagination state
      let currentPage = 1;
      let pageSize = 10;
      let filteredList = [];

      const views = {
        dashboard: document.getElementById("view-dashboard"),
        students: document.getElementById("view-students"),
        program: document.getElementById("view-program"),
        subject: document.getElementById("view-subject"),
        rollno: document.getElementById("view-rollno"),
        student: document.getElementById("view-student"),
      };

      function hideAll() {
        Object.values(views).forEach((v) => v.classList.add("hidden"));
      }
      function showView(name) {
        hideAll();
        views[name].classList.remove("hidden");
        document.getElementById("pageTitle").textContent =
          name.charAt(0).toUpperCase() + name.slice(1);
      }

            // apply filters -> compute filteredList and show first page
      function applyFiltersAndRender() {
       

        const session = document.getElementById("sessionSelect").value || null;
        const program = document.getElementById("programInput").value || null;
        const subjectSelect = document.getElementById("subjectFilter");
        if (!Academic.selected_pgmid  || session==="All Sessions") {
          alert("Please select a valid program or session from the list.");
          return;
        }
        getstudents();
       
      }

      function renderPage() {
        const tbody = document.getElementById("studentsTableBody");
        const total = filteredList.length;

        if (total === 0) {
          tbody.innerHTML =
            '<tr><td class="p-4" colspan="4" style="color:blue">No students match the selected filters.</td></tr>';
          document.getElementById("showingRange").textContent = "0-0";
          document.getElementById("currentPage").textContent = "1";
          return;
        }
        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, total);
        const pageItems = filteredList.slice(start, end);
        console.log("rendering page Arush", currentPage, pageItems,start,end);
        const tr = document.createElement("tr");
         tbody.innerHTML = "";
         count=0;
         pageItems.forEach((s) => {
         console.log(count++,"arush",s);
          const tr = document.createElement("tr");
         tr.innerHTML = `
            <td><a href="#rollno/${s.roll_number}/${Academic.selected_pgmid}"
               class="text-blue-600 hover:underline" >${s.roll_number} </a></td>
            <td>${s.student_first_name ?? ""}</td>
            <td>${Academic.selected_pgm ?? ""}</td>
            <td>${s.semester_code ?? ""}</td>
            <td>${s.branch_id ?? ""}</td>
            <td>${s.specialization_id ?? ""}</td>
            <td><a href="#subject/${s.program_course_key}/${
              Academic.selected_year
            }/${s.course_code}/${s.startdate}/${s.enddate}           "
              class="text-blue-600 hover:underline">${
                s.course_code ?? ""
              }</a></td>
            <td>${Academic.selected_year ?? ""}</td>

                `;
          tbody.appendChild(tr);
        });




        document.getElementById("showingRange").textContent = `${
          start + 1
        }-${end}`;
        document.getElementById("currentPage").textContent = currentPage;
        document.getElementById("totalCount").textContent = total;
        // disable/enable buttons
        document.getElementById("prevPage").disabled = currentPage <= 1;
        document.getElementById("nextPage").disabled = end >= total;
      }

      // class, subject, student render functions (unchanged from before)
      function renderClass(programId, year) {
        
        document.getElementById("classLabel").textContent = `Class: ${
          students.length ? students[0].program : "Unknown"
        } — ${year}`;
        document.getElementById(
          "classMeta"
        ).textContent = `Program ID ${programId}`;
        document.getElementById("clsCount").textContent = students.length;
        
        document.getElementById("clsAvg").textContent =
          avg !== "—" ? avg + "%" : "—";
        document.getElementById("clsPass").textContent =
          passpct !== "—" ? passpct + "%" : "—";

        const subs = demoSubjects[programId] || [];
        const subContainer = document.getElementById("classSubjects");
        subContainer.innerHTML = "";
        
        const tbody = document.getElementById("classStudentsBody");
        tbody.innerHTML = "";
        students.forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td class="p-2"><a href="#student/${s.id}" class="text-blue-600 hover:underline">${s.roll}</a></td><td class="p-2">${s.name}</td>`;
          tbody.appendChild(tr);
        });
      }

      function renderSubject(programId, year, subjectId) {
        
        document.getElementById("subjectLabel").textContent = `${
          Academic.subject  ? Academic.subject : "Subject"
        } — ${year}`;
        document.getElementById(
          "subjectMeta"
        ).textContent = `Program ${Academic.selected_pgm}`;
        
        
       
        
      }

      function renderStudent(id) {
       
        document.getElementById("stuName").textContent = `${s.name}`;
        document.getElementById(
          "stuMeta"
        ).textContent = `${s.roll} • ${s.program} — ${s.year}`;
        
        document.getElementById("stuPct").textContent =
          overall !== "—" ? overall + "%" : "—";
        document.getElementById("stuAtt").textContent =
          70 + Math.floor(Math.random() * 20) + "%";
        const subs = demoSubjects[s.program_id] || [];
        const tbody = document.getElementById("studentSubjectsBody");
        tbody.innerHTML = "";
        
        
        const backLink = document.getElementById("backToClassLink");
        backLink.href = `#class/${s.program_id}/${s.year}`;
      }
    function destroyHistogram() {
      const histDiv = document.getElementById("histogramContainer");
      if (histDiv) {
        histDiv.innerHTML = ""; // remove chart + table
      }
    }
      // hash routing
      function handleHash(e) {
        console.log("hash changed");
        console.log("old:", e.oldURL);
        console.log("new:", e.newURL);
         if (window.currentChart) window.currentChart.destroy();
         destroyHistogram();

        const hash = location.hash.slice(1);
        console.log("hash", hash);
        const h = location.hash.replace(/^#/, "");
        if (!h || h === "dashboard") {
          showView("dashboard");
          return;
        }
        if (h === "students") {
         
          showView("students");
          return;
        }

        console.log("arush hash", h);
        if (h.startsWith("program/")) {
          const parts = h.split("/");
          const prog = parseInt(parts[1]);
          const yr = parseInt(parts[2]);
          showView("program");
          renderClass(prog, yr);
          return;
        }
        if (h.startsWith("subject/")) {
          showView("subject");
          const container = document.getElementById("components-container");
          const parts = h.split("/");

          const pck = parts[1]; // program_course_key
          console.log("arush pck", pck);
          const pgmid = pck.substring(0, 7);
          console.log("arush pgmid", pgmid);
          const yr = parts[2];
          const subject = parts[3];
          const startdate = parts[4];
          const enddate = parts[5];
          Academic.subject = subject;
          window.academic.selected_pgmid = pgmid;
          console.log("Arush subject", yr, subject);

          let programId = Academic.selected_pgmid || "";
          const apiUrl = `/academic/api/components/?subject=${subject}&program_id=${
            Academic.selected_pgmid || ""
          }`;
          container.dataset.apiUrl = apiUrl;
          container.dataset.pck = pck;
          container.dataset.yr = yr;
          container.dataset.subject = subject;
          container.dataset.startdate = startdate;
          container.dataset.enddate = enddate;
          container.dataset.pgmid = pgmid;


          if (window.loadComponents) window.loadComponents();
          renderSubject(pgmid, yr, subject);
          return; 
        }
        if (h.startsWith("rollno/")) {
          showView("rollno");
          const container1 = document.getElementById("rollno_chart_Container");
          console.log("container1",container1);
          const parts = h.split("/");

          const rollno = parts[1]; // program_course_key
          
          const pgmid = parts[2];
          
          
          
          window.academic.selected_pgmid = pgmid;
        

          let programId = Academic.selected_pgmid || "";
          
                   
          container1.dataset.rollno = rollno;
          container1.dataset.pgmid = pgmid;
          
          return;
        }

        if (h.startsWith("student/")) {
          const parts = h.split("/");
          const id = parseInt(parts[1]);
          showView("student");
          renderStudent(id);
          return;
        }
        // fallback
        showView("dashboard");
      }

      // events and pagination handlers
      window.addEventListener("hashchange", handleHash);
      document
        .getElementById("backTostudentsFromRollno")
        .addEventListener("click", () => {
          location.hash = "#students";
        });
      document
        .getElementById("backTostudentsFronSubject")
        .addEventListener("click", () => {
           
          location.hash = "#students";
        });
      {% comment %} document
        .getElementById("programList")
        .addEventListener("change", (e) =>
          populateSubjectFilterForProgram(parseInt(e.target.value) || null)
        ); {% endcomment %}
      document
        .getElementById("applyFilters")
        .addEventListener("click", () => applyFiltersAndRender());
      document.getElementById("pageSize").addEventListener("change", () => {
        pageSize = parseInt(document.getElementById("pageSize").value);
        currentPage = 1;
        renderPage();
      });
      document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage();
        }
      });
      document.getElementById("nextPage").addEventListener("click", () => {
        const total = filteredList.length;
        if (currentPage * pageSize < total) {
          currentPage++;
          renderPage();
        }
      });

      
      getsessions();
      getprograms();
       // initial view     
      if (!location.hash) location.hash = "#dashboard";
      else handleHash();
    </script>
  </body>
</html>
