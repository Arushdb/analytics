<!-- templates/analytics/subject_detail.html -->
{% extends "base.html" %}
{% block content %}
<div class="bg-white p-4 rounded shadow">
  <div class="flex justify-between items-start">
    <div>
      <h2 id="subjectName" class="text-xl font-semibold">Subject</h2>
      <p id="classLabel" class="text-sm text-gray-600">Program — Year</p>
    </div>
    <div>
      <a id="backToClass" class="text-sm text-blue-600 hover:underline" href="#">Back to Class</a>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
    <div class="p-3 bg-white rounded shadow">
      <h3 class="font-medium mb-2">Student averages</h3>
      <canvas id="subjectStudentBar" height="240"></canvas>
    </div>

    <div class="p-3 bg-white rounded shadow">
      <h3 class="font-medium mb-2">Distribution (buckets)</h3>
      <canvas id="subjectBuckets" height="240"></canvas>
      <div id="bucketsLegend" class="mt-2 text-sm"></div>
    </div>
  </div>

  <div class="bg-white p-3 rounded shadow mt-4">
    <h3 class="font-medium mb-2">Students</h3>
    <table class="min-w-full">
      <thead><tr><th class="p-2 text-left">Roll</th><th class="p-2 text-left">Name</th><th class="p-2 text-left">Avg %</th></tr></thead>
      <tbody id="subjectStudentsTable"></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const programId = {{ program.id }};
const year = {{ year }};
const subjectId = {{ subject.id }};

async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('Fetch failed: ' + r.status);
  return await r.json();
}

async function renderSubjectDetail(){
  const data = await fetchJSON("{% url 'analytics:subject_detail_api' program.id year subject.id %}");
  document.getElementById('subjectName').textContent = data.subject.name;
  document.getElementById('classLabel').textContent = `${data.summary.count} students • ${programId} — ${year}`;
  document.getElementById('backToClass').href = `{% url 'analytics:class_performance' program.id year %}`;

  // per-student bar chart (sorted desc)
  const studentsWithAvg = data.students.filter(s=>s.avg_percent !== null).sort((a,b)=>b.avg_percent - a.avg_percent);
  const labels = studentsWithAvg.map(s => s.roll_number);
  const values = studentsWithAvg.map(s => s.avg_percent);

  const ctx = document.getElementById('subjectStudentBar').getContext('2d');
  if(window.subBar) window.subBar.destroy();
  window.subBar = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Avg %', data: values }] },
    options: { responsive: true, scales: { y: { beginAtZero: true, max:100 } } }
  });

  // buckets
  const buckets = {"<40":0,"40-59":0,"60-79":0,"80-100":0};
  studentsWithAvg.forEach(s => {
    const p = s.avg_percent;
    if(p < 40) buckets["<40"]++;
    else if(p < 60) buckets["40-59"]++;
    else if(p < 80) buckets["60-79"]++;
    else buckets["80-100"]++;
  });
  const bucketLabels = Object.keys(buckets);
  const bucketValues = Object.values(buckets);
  const ctx2 = document.getElementById('subjectBuckets').getContext('2d');
  if(window.subBuckets) window.subBuckets.destroy();
  window.subBuckets = new Chart(ctx2, { type: 'doughnut', data: { labels: bucketLabels, datasets: [{ data: bucketValues }] } });
  // legend
  const legend = document.getElementById('bucketsLegend');
  legend.innerHTML = bucketLabels.map((k,i)=> `<div><strong>${k}</strong>: ${bucketValues[i]}</div>`).join('');

  // populate table (include students without scores too)
  const tbody = document.getElementById('subjectStudentsTable');
  tbody.innerHTML = '';
  data.students.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${s.roll_number}</td><td class="p-2">${s.name}</td><td class="p-2">${s.avg_percent !== null ? s.avg_percent + '%' : '—'}</td>`;
    tbody.appendChild(tr);
  });
}

document.addEventListener('DOMContentLoaded', renderSubjectDetail);
</script>
{% endblock %}
