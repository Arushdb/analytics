  <h2>{{ section_title }}</h2>
  <form id="student-form">
    
  <div class="grid md:grid-cols-2 gaclass ">
            <!-- Charts with toggle functionality -->
            <div class="md:col-span-2 w-full">
              <!-- Component Performance Bar Chart -->
              <select
                id="chartTypeSelect1"
                class="border rounded px-2 py-1 mb-4"
              >
                <option value="gpa">GPA trend</option>
                <option value="attendence">Attendence %</option>
                <option value="subj_marks">Subject wise Marks</option>
                <option value="risk">Early Warning</option>
                <option value="career">Career Readiness </option>
              </select>
         <button  class ="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400 transition"  type="submit">Submit</button>
     
              <div
                id="rollnoChartContainer"
                class="chart-container"
                data-rollno="{{ rollno }}"
                data-pgmid="{{ program_id }}"
              ></div>
                             
              </div>
            </div>
          

  </form>

  <script>
    window.semesterCharts = [];
    window.currentChart = null;
    const chartTypeMap = {
      gpa: "line",
      attendance: "bar",
      subj_marks: "bar",
      risk: "bar", // placeholder; replace with histogram plugin if needed
      career: "bar" // placeholder
      };
    document.getElementById('student-form').addEventListener('submit', async(e) => {
      e.preventDefault();

      const markstype = document.getElementById("chartTypeSelect1").value;
      const charttype = chartTypeMap[markstype] || "bar";
      getstudentdata({charttype,markstype});  
      
    });

 

     async function getstudentdata({ charttype ,markstype } = {}) {
      
        const container = document.getElementById('rollnoChartContainer');
            
        rollno=container.dataset.rollno
        pgmid=container.dataset.pgmid
        const params = new URLSearchParams();
        
        params.append("rollno", rollno);
        params.append("program_id", pgmid);
        let url = "";
        if (markstype === "gpa") url = `/academic/api/get_sgpa_average?${params.toString()}`;
        if (markstype === "subj_marks") url = `/academic/api/get_sub_gradepoint?${params.toString()}`;
        
        if (!url) {
        console.warn("No URL mapped for:", markstype);
        return;
        }
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        container.style.display = "";
        renderChart1({charttype, markstype, data});
  

}

function renderChart1({ charttype, markstype, data }) {
        console.log("Arush data", data);
        // Grades distribution (if you later add it)
        if (markstype === "grades") {
          const ctx = resetCharts();
          const gradesdata = {
            labels: data.map((d) => d.internal_grade),
            datasets: [{ label: "Count", data: data.map((d) => d.count) }],
          };
          window.currentChart = new Chart(ctx, { type: charttype, data: gradesdata, options: {} });
          return;
        }

        if (markstype === "subj_marks") {
          drawSubjectChartsBySemester(data);
          return;
        }

        if (markstype === "gpa") {
          renderGpaTrend(data);
          return;
        }

        // TODO: attendance / risk / career renderers
        const ctx = resetCharts();
        window.currentChart = new Chart(ctx, {
          type: charttype,
          data: { labels: [], datasets: [] },
          options: { plugins: { title: { display: true, text: `${markstype} (not yet implemented)` } } },
        });
      }


function resetCharts() {
// destroy multi-semester charts
if (window.semesterCharts && window.semesterCharts.length) {
window.semesterCharts.forEach((ch) => ch.destroy());
window.semesterCharts = [];
}
// destroy single canvas chart
if (window.currentChart) {
window.currentChart.destroy();
window.currentChart = null;
}
// clear container and re-insert a fresh canvas
const container = document.getElementById("rollnoChartContainer");
container.innerHTML = "";
const canvas = document.createElement("canvas");
canvas.id = "main-canvas";
container.appendChild(canvas);
return canvas.getContext("2d");
}
function renderGpaTrend(data) {
        const ctx = resetCharts();

        // Collect labels (semesters)
        const labels = [];
        for (const row of (data.peeraverage || [])) {
          if (!labels.includes(row.semester)) labels.push(row.semester);
        }
        for (const row of (data.studentavg || [])) {
          if (!labels.includes(row.semester)) labels.push(row.semester);
        }

        // Build series
        const bySem = { peeraverage: {}, studentavg: {} };
        for (const row of (data.peeraverage || [])) bySem.peeraverage[row.semester] = Number(row.sgpa);
        for (const row of (data.studentavg || [])) bySem.studentavg[row.semester] = Number(row.sgpa);

        const colorFor = (i) => {
          const hue = (i * 47) % 360;
          const solid = `hsl(${hue} 70% 45%)`;
          const fill  = `hsl(${hue} 70% 45% / 0.2)`;
          return { solid, fill };
        };

        const seriesNames = Object.keys(bySem);
        const datasets = seriesNames.map((name, i) => {
          const { solid, fill } = colorFor(i);
          return {
            label: name,
            data: labels.map((sem) => bySem[name][sem] ?? null),
            borderColor: solid,
            backgroundColor: fill,
            borderWidth: 2,
            pointRadius: 3,
            tension: 0.25,
            fill: false,
            spanGaps: true,
          };
        });

        const chartData = { labels, datasets };

        window.currentChart = new Chart(ctx, {
          type: "line",
          data: chartData,
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            plugins: {
              legend: { position: "top" },
              title: { display: true, text: "GPA Trend" },
              tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y ?? "—"}` } },
            },
            scales: {
              x: { title: { display: true, text: "Semester" }, ticks: { autoSkip: true, maxRotation: 0 } },
              y: { beginAtZero: true, title: { display: true, text: "SGPA" } },
            },
          },
        });
      }

      function drawSubjectChartsBySemester(data) {
        // Destroy any prior charts and clear container (no main canvas for multi-charts)
        if (window.semesterCharts && window.semesterCharts.length) {
          window.semesterCharts.forEach((ch) => ch.destroy());
          window.semesterCharts = [];
        }
        const container = document.getElementById("rollnoChartContainer");
        container.innerHTML = "";

        // Group by semester
        const groups = {};
        (data.subgrade || []).forEach((row) => {
          const sem = row.semester;
          (groups[sem] ||= []).push(row);
        });

        // Build a chart per semester
        Object.entries(groups).forEach(([semester, subjects], idx) => {
          const wrap = document.createElement("div");
          wrap.className = "bg-white rounded-lg border border-gray-200 p-4 mb-4";

          const h = document.createElement("h3");
          h.className = "text-lg font-semibold mb-2";
          h.textContent = `Subject-wise Grade Points — ${semester}`;
          wrap.appendChild(h);

          const canvas = document.createElement("canvas");
          wrap.appendChild(canvas);
          container.appendChild(wrap);

          const labels = subjects.map((d) => d.subject);
          const dataPoints = subjects.map((d) => Number(d.grade_point));
          const colors = labels.map(() => randomColor());

          const ch = new Chart(canvas.getContext("2d"), {
            type: "bar",
            data: {
              labels,
              datasets: [{ label: `Grade Points — ${semester}` , data: dataPoints, backgroundColor: colors, borderColor: colors.map(c => c.replace('0.7', '1')), borderWidth: 1 }],
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: "Grade Point" } },
                x: { title: { display: true, text: "Subject Code" } },
              },
            },
          });

          window.semesterCharts.push(ch);
        });
      }


 function randomColor() {
  const r = Math.floor(Math.random() * 200);
  const g = Math.floor(Math.random() * 200);
  const b = Math.floor(Math.random() * 200);
  return `rgba(${r}, ${g}, ${b}, 0.7)`;
}
    
  </script>
</body>
</html>
